#!/bin/bash
set -e

APP_DIR="/usr/share/a.m.d-helper"
VENV_DIR="$APP_DIR/venv"
LOG_FILE="/tmp/a.m.d-helper-install.log"

# Start with a clean log file and provide user-facing status updates.
echo "--- A.M.D-HELPER Installation Log ---" > "$LOG_FILE"
date >> "$LOG_FILE"
echo "------------------------------------" >> "$LOG_FILE"

echo "Starting A.M.D-HELPER post-installation setup..."
echo "A detailed log is available in $LOG_FILE"

REAL_USER=${SUDO_USER:-$(whoami)}
USER_HOME=$(getent passwd "$REAL_USER" | cut -d: -f6)
echo "Installation user: $REAL_USER" >> "$LOG_FILE"

# --- 1. Create and populate virtual environment ---
echo "Creating Python virtual environment with access to system site-packages..."
# Using --system-site-packages is key to allow the venv to use system-installed libraries like PyGObject (python3-gi)
python3 -m venv --system-site-packages "$VENV_DIR" >> "$LOG_FILE" 2>&1

echo "Installing Python dependencies. This may take several minutes..."

# Setup pip options
PIP_MIRROR_OPTIONS="--index-url https://pypi.tuna.tsinghua.edu.cn/simple"
PIP_TIMEOUT_OPTION="--timeout 90"

# Upgrade pip, showing progress to the user via tee
echo "Step 1/3: Upgrading pip..."
if ! "$VENV_DIR/bin/pip" install $PIP_TIMEOUT_OPTION $PIP_MIRROR_OPTIONS --upgrade pip 2>&1 | tee -a "$LOG_FILE"; then
    echo "Pip upgrade with mirror failed. Retrying with default PyPI..." | tee -a "$LOG_FILE"
    if ! "$VENV_DIR/bin/pip" install $PIP_TIMEOUT_OPTION --upgrade pip 2>&1 | tee -a "$LOG_FILE"; then
        echo "FATAL: Failed to upgrade pip." | tee -a "$LOG_FILE"
        exit 1
    fi
fi

# Install requirements, showing progress to the user via tee
# PyGObject will be skipped by pip because it's already visible from the system site-packages.
echo "Step 2/3: Installing application requirements..."
if ! "$VENV_DIR/bin/pip" install $PIP_TIMEOUT_OPTION $PIP_MIRROR_OPTIONS -r "$APP_DIR/requirements.txt" 2>&1 | tee -a "$LOG_FILE"; then
    echo "Installation with mirror failed. Retrying with default PyPI..." | tee -a "$LOG_FILE"
    if ! "$VENV_DIR/bin/pip" install $PIP_TIMEOUT_OPTION -r "$APP_DIR/requirements.txt" 2>&1 | tee -a "$LOG_FILE"; then
        echo "FATAL: Failed to install requirements." | tee -a "$LOG_FILE"
        exit 1
    fi
fi

# Install the local libshot library
echo "Step 3/3: Installing local libshot library..."
if ! "$VENV_DIR/bin/pip" install "$APP_DIR/libshot" 2>&1 | tee -a "$LOG_FILE"; then
    echo "FATAL: Failed to install local libshot library." | tee -a "$LOG_FILE"
    exit 1
fi
echo "Dependency installation complete."


# --- 2. Set file permissions ---
echo "Setting file permissions..."
{
    chown -R root:root "$APP_DIR"
    chmod +x "$APP_DIR/run.sh"
    chmod +x "$APP_DIR/run_fast.sh"
    chmod +x "$APP_DIR/run_hover.sh"
    chmod +x "$APP_DIR/tray.sh"
} >> "$LOG_FILE" 2>&1


# --- 3. Set custom keyboard shortcut for F4 ---
echo "Setting up keyboard shortcut..."
{
    if command -v gsettings &> /dev/null && [ -n "$USER_HOME" ]; then
        echo "Attempting to set F4 keyboard shortcut for GNOME..."

        DBUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
        if [ -z "$XDG_RUNTIME_DIR" ]; then
            XDG_RUNTIME_DIR="/run/user/$(id -u $REAL_USER)"
            DBUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
        fi

        run_gsettings() { sudo -u "$REAL_USER" DBUS_SESSION_BUS_ADDRESS="$DBUS_ADDRESS" timeout 5 gsettings "$@"; }

        SHORTCUT_APP_NAME="A.M.D-HELPER OCR"
        CMD_TO_RUN="/usr/share/a.m.d-helper/run.sh"
        BINDING="F4"
        
        TARGET_SLOT=""
        # Loop through a reasonable number of custom keybinding slots
        for i in {0..19}; do
            SLOT_PATH="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/custom$i/"
            # A slot is available if getting its name fails (returns 'free') or if the name is empty ('') or already set to our app's name.
            EXISTING_NAME=$(run_gsettings get org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:"$SLOT_PATH" name 2>/dev/null || echo "free")
            
            if [[ "$EXISTING_NAME" == "free" || "$EXISTING_NAME" == "''" || "$EXISTING_NAME" == "'$SHORTCUT_APP_NAME'" ]]; then
                TARGET_SLOT="custom$i"
                break
            fi
        done

        if [ -n "$TARGET_SLOT" ]; then
            echo "Using available keybinding slot: $TARGET_SLOT"
            KEYBINDING_PATH="org.gnome.settings-daemon.plugins.media-keys.custom-keybinding:/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/$TARGET_SLOT/"
            SLOT_URI="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/$TARGET_SLOT/"

            run_gsettings set "$KEYBINDING_PATH" name "$SHORTCUT_APP_NAME"
            run_gsettings set "$KEYBINDING_PATH" command "$CMD_TO_RUN"
            run_gsettings set "$KEYBINDING_PATH" binding "$BINDING"

            # Add the new slot to the list of custom keybindings if it's not already there
            CURRENT_BINDINGS_STR=$(run_gsettings get org.gnome.settings-daemon.plugins.media-keys custom-keybindings | sed "s/@as //" )
            if [[ ! "$CURRENT_BINDINGS_STR" =~ "$SLOT_URI" ]]; then
                # Safely append the new URI to the list
                NEW_BINDINGS_STR=$(python3 -c "import sys, ast; l=ast.literal_eval(sys.argv[1]); l.append(sys.argv[2]); print(l)" "$CURRENT_BINDINGS_STR" "$SLOT_URI")
                run_gsettings set org.gnome.settings-daemon.plugins.media-keys custom-keybindings "$NEW_BINDINGS_STR"
            fi
            echo "GNOME shortcut setup completed for slot $TARGET_SLOT."
        else
            echo "WARNING: Could not find an available custom keybinding slot after checking custom0 through custom19. Shortcut not set."
        fi
    else
        echo "WARNING: 'gsettings' command not found or not running in a user session. Could not set F4 keyboard shortcut."
    fi
} >> "$LOG_FILE" 2>&1

echo "Installation finished successfully."
exit 0
