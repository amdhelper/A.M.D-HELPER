# 项目需求文档：Linux 统一屏幕截图库

## 1. 项目背景与目标

### 1.1. 问题陈述

当前，大量的 Python 应用（如自动化工具、OCR 软件、取色器等）在现代 Linux 发行版上遭遇了严重的兼容性问题。其根本原因在于 Linux 桌面环境正从传统的 **X11** 显示服务器向更安全的 **Wayland** 协议迁移。许多现有的截图库（如 `mss`, `PyAutoGUI` 等）深度依赖 X11 的 `XGetImage` 等特定接口，这在 Wayland 的安全模型下是无效的，从而导致 `XGetImage() failed` 等致命错误。

### 1.2. 项目目标

本项目的目标是开发一个名为 **`libshot`** (暂定名) 的、高性能的、纯 Python 底层依赖库。它将提供一个统一、简洁的 API，能够**自动适应并兼容 Wayland 和 X11 两种环境**，从而让上层应用开发者无需关心底层的显示服务器差异，实现“一次编码，到处运行”的截图功能。

## 2. 功能需求 (Functional Requirements)

| ID | 需求描述 | 优先级 |
| :--- | :--- | :--- |
| **FR-1** | **环境自动检测** | 关键 |
| | 库必须能在初始化时自动检测当前的桌面会话是 Wayland 还是 X11，并选择合适的后端执行截图。 | |
| **FR-2** | **统一截图 API** | 关键 |
| | 提供一个核心的截图函数，例如 `libshot.capture(region=None, monitor=1)`，其行为在 Wayland 和 X11 下应完全一致。 | |
| | - `region`: 一个可选的 `(x, y, width, height)` 元组，用于截取屏幕的特定矩形区域。 | |
| | - `monitor`: 可选的显示器编号，用于在多显示器环境中指定截图对象。 | |
| | - 如果参数为空，则默认截取主显示器的全屏。 | |
| **FR-3** | **Wayland 兼容性** | 关键 |
| | 在 Wayland 环境下，库必须通过 `xdg-desktop-portal` 的 D-Bus 接口来请求截图。这是 Wayland 下进行屏幕交互的标准、安全方式。 | |
| | - 库需要处理与 D-Bus 的异步通信。 | |
| | - 库应能处理用户通过系统弹窗授予或拒绝权限的场景。 | |
| **FR-4** | **X11 兼容性** | 关键 |
| | 在 X11 环境下，库应使用成熟、高效的方式进行截图，例如直接调用 `python-xlib` 或 `mss` 的底层 X11 实现，作为兼容后盾。 | |
| **FR-5** | **标准化的输出** | 关键 |
| | `capture()` 函数的返回值必须是标准、易用的格式，推荐为 **Pillow 的 `Image` 对象**或 **NumPy 数组**，并确保格式统一。 | |
| **FR-6** | **多显示器支持** | 重要 |
| | 提供一个辅助函数，例如 `libshot.list_monitors()`，用于列出当前系统中所有已连接的显示器及其分辨率和位置信息。 | |

## 3. 非功能性需求 (Non-Functional Requirements)

| ID | 需求描述 | 优先级 |
| :--- | :--- | :--- |
| **NFR-1** | **高性能与低延迟** | 关键 |
| | 截图过程必须足够快，以支持近乎实时的应用场景（如屏幕录制、高频 OCR 等）。 | |
| **NFR-2** | **最小化依赖** | 重要 |
| | 库本身的依赖应尽可能少。例如，仅在需要时才引入 `jeepney` (D-Bus 库) 或 `python-xlib`。所有依赖必须在 `pyproject.toml` 中明确声明。 | |
| **NFR-3** | **清晰的错误处理** | 关键 |
| | 必须定义一套清晰、具体的异常类型。例如： | |
| | - `PermissionDeniedError`: 当用户在 Wayland 弹窗中拒绝授权时抛出。 | |
| | - `UnsupportedError`: 当系统既非 Wayland 也非 X11，或缺少 `xdg-desktop-portal` 支持时抛出。 | |
| | - `InvalidRegionError`: 当指定的截图区域超出屏幕边界时抛出。 | |
| **NFR-4** | **完善的文档** | 重要 |
| | 提供高质量的文档，包括： | |
| | - `README.md`: 包含项目介绍、安装指南和快速上手的代码示例。 | |
| | - **API 文档**: 所有公开的函数和类都必须有详细的 Docstrings。 | |
| | - **Wayland 说明**: 必须在文档中特别说明在 Wayland 下首次截图会触发系统级权限弹窗。 | |
| **NFR-5** | **开源许可** | 关键 |
| | 采用宽松的开源许可证（如 **MIT** 或 **Apache 2.0**），以鼓励社区和商业项目广泛采用。 | |
| **NFR-6** | **跨平台设计** | 一般 |
| | 虽然首要目标是解决 Linux 的问题，但库的 API 设计应具备良好的扩展性，为未来支持 Windows 和 macOS 留下可能。 | |

## 4. 高层架构设计草图

```python
# --- API 使用示意 ---
import libshot
import cv2
import numpy

try:
    # 截取全屏
    img = libshot.capture() 
    img.save("fullscreen.png")

    # 截取特定区域
    region_img = libshot.capture(region=(100, 100, 500, 500))
    
    # 与 OpenCV 集成
    frame = cv2.cvtColor(numpy.array(region_img), cv2.COLOR_RGB2BGR)
    cv2.imshow("Region", frame)

except libshot.PermissionDeniedError:
    print("用户拒绝了截图权限。")
except libshot.UnsupportedError as e:
    print(f"系统环境不受支持: {e}")

# --- 内部实现伪代码 ---

# libshot/__init__.py
def capture(region=None, monitor=1):
    return _get_backend().capture(region, monitor)

def _get_backend():
    # 单例模式，检测一次后缓存结果
    if hasattr(libshot, "_backend"):
        return libshot._backend
    
    session = os.environ.get("XDG_SESSION_TYPE")
    if session == "wayland":
        libshot._backend = WaylandBackend()
    elif session == "x11":
        libshot._backend = X11Backend()
    else:
        raise UnsupportedError("无法识别的显示服务器。")
    return libshot._backend

# libshot/backends.py
class WaylandBackend:
    def capture(self, region, monitor):
        # 1. 连接 D-Bus
        # 2. 调用 xdg-desktop-portal 的 Screenshot 接口
        # 3. 等待并接收返回的文件 URI 或数据流
        # 4. 加载图像数据，转换为 Pillow Image
        # 5. 如果有 region，进行裁剪
        # 6. 返回 Image 对象
        pass

class X11Backend:
    def capture(self, region, monitor):
        # 1. 使用 mss 或 xlib
        # 2. 抓取屏幕数据
        # 3. 转换为 Pillow Image
        # 4. 返回 Image 对象
        pass
```

## 5. 验收标准

- 库能成功打包并发布到 PyPI。
- 开发者可以通过 `pip install libshot` 成功安装。
- 同一个上层应用脚本，无需任何修改，即可在 Ubuntu (Wayland) 和 Ubuntu (Xorg) 两种会话下成功截图。
- `speechfy` 项目成功集成该库，彻底解决了 `XGetImage() failed` 的问题。
